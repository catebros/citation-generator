name: CD Pipeline - Deploy to Azure

on:
  push:
    branches: [ 'main' ]
  workflow_dispatch:  # Allow manual triggering

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_BACKEND: ${{ github.repository }}/backend
  IMAGE_NAME_FRONTEND: ${{ github.repository }}/frontend

jobs:
  # Run tests first - deployment only happens if tests pass
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        pip install -r ../requirements.txt
        pip install pytest pytest-cov

    - name: Run tests with coverage
      working-directory: ./backend
      run: |
        pytest tests/ -v --cov=. --cov-report=term

    - name: Check coverage threshold (70% minimum)
      working-directory: ./backend
      run: |
        coverage report --fail-under=70

  build-and-push-images:
    needs: test  # Only build if tests pass
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata for Backend
      id: meta-backend
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}
        tags: |
          type=sha,prefix={{branch}}-
          type=ref,event=branch
          type=semver,pattern={{version}}
          latest

    - name: Build and push Backend Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./backend/Dockerfile
        push: true
        tags: ${{ steps.meta-backend.outputs.tags }}
        labels: ${{ steps.meta-backend.outputs.labels }}

    - name: Extract metadata for Frontend
      id: meta-frontend
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}
        tags: |
          type=sha,prefix={{branch}}-
          type=ref,event=branch
          type=semver,pattern={{version}}
          latest

    - name: Build and push Frontend Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        file: ./frontend/Dockerfile
        build-args: |
          VITE_API_URL=https://${{ secrets.AZURE_WEBAPP_BACKEND }}.azurewebsites.net
        push: true
        tags: ${{ steps.meta-frontend.outputs.tags }}
        labels: ${{ steps.meta-frontend.outputs.labels }}

  deploy-to-azure:
    runs-on: ubuntu-latest
    needs: build-and-push-images
    environment:
      name: 'Production'
      url: ${{ steps.deploy-backend.outputs.webapp-url }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Validate required secrets
      shell: bash
      env:
        AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
        AZURE_WEBAPP_BACKEND: ${{ secrets.AZURE_WEBAPP_BACKEND }}
        AZURE_WEBAPP_FRONTEND: ${{ secrets.AZURE_WEBAPP_FRONTEND }}
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
      run: |
        set -euo pipefail
        missing=0
        for key in AZURE_RESOURCE_GROUP AZURE_WEBAPP_BACKEND AZURE_WEBAPP_FRONTEND DATABASE_URL; do
          val="${!key:-}"
          if [ -z "$val" ]; then
            echo "::error ::Missing or empty secret: $key"
            missing=1
          fi
        done
        if [ "$missing" -ne 0 ]; then
          echo "Required secrets are missing. Failing deployment."
          exit 1
        fi

    - name: Configure Backend Web App Settings
      env:
        AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
        AZURE_WEBAPP_BACKEND: ${{ secrets.AZURE_WEBAPP_BACKEND }}
        AZURE_WEBAPP_FRONTEND: ${{ secrets.AZURE_WEBAPP_FRONTEND }}
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
      run: |
        set -euo pipefail
        echo "Configuring backend web app settings..."
        az webapp config appsettings set \
          --resource-group "$AZURE_RESOURCE_GROUP" \
          --name "$AZURE_WEBAPP_BACKEND" \
          --settings \
            "DATABASE_URL=$DATABASE_URL" \
            "ALLOWED_ORIGINS=https://$AZURE_WEBAPP_FRONTEND.azurewebsites.net,https://$AZURE_WEBAPP_BACKEND.azurewebsites.net" \
            "WEBSITES_PORT=8000" \
            "ENVIRONMENT=production" \
            "DOCKER_ENABLE_CI=true"

    - name: Configure Frontend Web App Settings
      env:
        AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
        AZURE_WEBAPP_BACKEND: ${{ secrets.AZURE_WEBAPP_BACKEND }}
        AZURE_WEBAPP_FRONTEND: ${{ secrets.AZURE_WEBAPP_FRONTEND }}
      run: |
        set -euo pipefail
        echo "Configuring frontend web app settings..."
        az webapp config appsettings set \
          --resource-group "$AZURE_RESOURCE_GROUP" \
          --name "$AZURE_WEBAPP_FRONTEND" \
          --settings \
            "VITE_API_URL=https://$AZURE_WEBAPP_BACKEND.azurewebsites.net" \
            "WEBSITES_PORT=3000" \
            "DOCKER_ENABLE_CI=true"

    - name: Deploy Backend to Azure Web App
      id: deploy-backend
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ secrets.AZURE_WEBAPP_BACKEND }}
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:latest

    - name: Deploy Frontend to Azure Web App
      id: deploy-frontend
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ secrets.AZURE_WEBAPP_FRONTEND }}
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:latest

    - name: Wait for Backend to be Ready
      env:
        AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
        AZURE_WEBAPP_BACKEND: ${{ secrets.AZURE_WEBAPP_BACKEND }}
      run: |
        set -euo pipefail
        echo "Waiting for backend to be ready..."
        HOST=$(az webapp show --name "$AZURE_WEBAPP_BACKEND" --resource-group "$AZURE_RESOURCE_GROUP" --query defaultHostName -o tsv)
        BACKEND_URL="https://${HOST}"

        for i in {1..30}; do
          if curl -f "$BACKEND_URL/health" &>/dev/null; then
            echo "Backend is healthy!"
            break
          fi
          echo "Waiting for backend to be ready... ($i/30)"
          sleep 10
        done

    - name: Azure Logout
      if: always()
      run: az logout

  verify-deployment:
    runs-on: ubuntu-latest
    needs: deploy-to-azure

    steps:
    - name: Resolve backend and frontend hostnames
      env:
        AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
        AZURE_WEBAPP_BACKEND: ${{ secrets.AZURE_WEBAPP_BACKEND }}
        AZURE_WEBAPP_FRONTEND: ${{ secrets.AZURE_WEBAPP_FRONTEND }}
      run: |
        set -euo pipefail
        BACKEND_HOST=$(az webapp show --name "$AZURE_WEBAPP_BACKEND" --resource-group "$AZURE_RESOURCE_GROUP" --query defaultHostName -o tsv)
        FRONTEND_HOST=$(az webapp show --name "$AZURE_WEBAPP_FRONTEND" --resource-group "$AZURE_RESOURCE_GROUP" --query defaultHostName -o tsv)
        echo "BACKEND_URL=https://${BACKEND_HOST}" >> $GITHUB_ENV
        echo "FRONTEND_URL=https://${FRONTEND_HOST}" >> $GITHUB_ENV

    - name: Check Backend Health
      run: |
        BACKEND_URL="${BACKEND_URL}"
        echo "Testing backend health endpoint..."
        for i in {1..10}; do
          if curl -f "$BACKEND_URL/health"; then
            echo "Backend health check passed"
            exit 0
          fi
          echo "Attempt $i failed, retrying..."
          sleep 5
        done
        echo "Backend health check failed"
        exit 1

    - name: Check Frontend Availability
      run: |
        FRONTEND_URL="${FRONTEND_URL}"
        echo "Testing frontend availability..."
        if curl -f -I "$FRONTEND_URL"; then
          echo "Frontend is accessible"
        else
          echo "Frontend check failed"
          exit 1
        fi

    - name: Deployment Summary
      run: |
        echo "Deployment completed successfully!"
        echo ""
        echo "Your Live URLs:"
        echo "   Backend API: ${BACKEND_URL}"
        echo "   Frontend:    ${FRONTEND_URL}"
        echo "   API Docs:    ${BACKEND_URL}/docs"
        echo ""
        echo "All health checks passed!"
